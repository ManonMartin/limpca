---
title: "Application of LMWiRe on the Trout dataset"
author: "Benaiche Nadia"
date: "`r Sys.Date()`"
package: LMWiRe
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
vignette: >
   %\VignetteIndexEntry{Analysis of the Trout dataset with LMWiRe}
   %\VignetteEncoding{UTF-8}
   %\VignetteEngine{knitr::rmarkdown}
editor_options: 
   chunk_output_type: console
references:
- id: Thiel2017
  title: ASCA+ and APCA+ Extensions of ASCA and APCA in the analysis of unbalanced multifactorial designs
  author:
  - family: Thiel
    given: Michel
  - family: Feraud
    given: Baptiste
  - family: Govaerts
    given: Bernadette
  container-title: Journal of Chemometrics
  type: article-journal
  issued:
    year: 2017
- id: Guisset2019
  title: Comparison of PARAFASCA, AComDim, and AMOPLS approaches in the multivariate GLM modelling of multi-factorial designs
  author:
  - family: Guisset
    given: Severine
  - family: Martin
    given: Manon
  - family: Govaerts
    given: Bernadette
  container-title: Chemometrics and Intelligent Laboratory Systems
  type: article-journal
  issued:
    year: 2019
---

```{r Setup,include=FALSE}
require(knitr)
require(pander)
knitr::opts_chunk$set(message=FALSE,warning=FALSE, comment=NA)

```

# 1 Introduction

The aim of this vignette is to give a brief example of the LMWiRe package. This package has been created to analyze models with wide responses and categorical parameters. The model used in this example is a three-way ANOVA with fixed effects. This document presents all the usual steps of the analysis starting from the data importation to the results visualization. The methods used come from the article of M. Thiel @Thiel2017 and S. Guisset @Guisset2019.

# 2 Installation

The package is actually in its developing stage and is available on GitHub at the URL : <https://github.com/FranceschiniS/LMWiRe>. It can be installed via the `devtools::install_github()` function. The package needs to be loaded afterwards.


```{r Install, results=FALSE, message=FALSE}

# devtools::install_github("FranceschiniS/LMWiRe")

library("LMWiRe")

```

# 3 Data importation

Before any analysis the `Trout data` needs to be loaded. The LMWiRe package contains the dataset and it can be loaded with the `data()` function. The `load()` function is also useful to import your own data.

```{r Data Importation}

data("trout")
outcomes <- trout$outcomes
formula<-trout$formula
design <- trout$design

```


# 4 Data visualisation

The trout dataset contains 3 elements : a matrix `responses` with 72 observations of 15 response variables, a formula for the GLM model used and a `design` matrix with 72 observations and 3 explanatory variables.

```{r Data visualization}


```


## 4.1 Formula

The formula is the formula of the ANOVA-GLM model used in this analysis.

```{r Formula}

trout$formula

```

## 4.2 Design

The design matrix contains the information about each observation for the three variables: Treatment, Day and Exposure.Cd The function `table` is useful to observe the design.

```{r Design}

pander(head(trout$design))

table(trout$design$Treatment,trout$design$Day,trout$design$Exposure.Cd)

```

## 4.3 Principal Component Analysis

The function `SVDforPCA` is useful to compute a PCA decomposition of the `responses` matrix. The `scores` and `loadings` can then be plotted with the function `DrawScores` and `DrawLoadings`.

```{r PCA}
ResPCA = SVDforPCA(trout$outcomes)
```

```{r VariancesPercentages}

eig.res = rbind(ResPCA$var[1:5], ResPCA$cumvar[1:5])
rownames(eig.res) = c("Variances", "Cum Var Values")
pander::pander(eig.res)

ggplot2::ggplot(data=as.data.frame(eig.res[1,]),ggplot2::aes(x=colnames(eig.res),y=eig.res[1,]))+
    ggplot2::geom_bar(stat="identity")+
    ggplot2::xlab("Principal Components")+
    ggplot2::ylab("Variance Percentage")

```

```{r Scores}

ScatterPlot(ResPCA$scores[,1],ResPCA$scores[,2])

DrawScores(ResPCA, type.obj = "PCA", drawNames = TRUE, createWindow = F, 
    main = "Reponse matrix score plot", color = trout$design$Exposure.Cd, pch = trout$design$Day, 
    axes = c(1, 2), size = 2.5) + ggplot2::scale_color_discrete(name = "Exposure.Cd") + ggplot2::scale_shape_discrete(name = "Day")

```


# 5 GLM decomposition

The analysis consists in decomposing the model matrix into effect matrices and performing a PCA on each of the effect matrices. 

The first step is to make the model matrix from the matrix of the experimental design. Each explanatory variable is reencoded with multiple binary variables. The model matrix is a \emph(72xK) with K being the total number of new binary variables.

The function `LMModelMatrix()` encodes the design matrix as a model matrix.

```{r ModelMatrix}

ResLMModelMatrix = LMModelMatrix(as.formula(trout$formula),trout$design)
pander::pander(head(ResLMModelMatrix$ModelMatrix))
```

The model matrix can then be decompose into effect matrices for every model terms with the function `LMEffectMatrices()`

```{r EffectMatrices}

ResLMEffectMatrices = LMEffectMatrices(ResLMModelMatrix, trout$outcomes)

```

## 5.1 Bootstrap test

We can use bootstrap to determine whether an effect is significant. We suggest the function `LMBootstrapTest()`.

```{r Bootstrap}

ResLMBootstrapTest= LMBootstrapTest(ResLMEffectMatrices = ResLMEffectMatrices,nboot=5)

# Print Pvalue

pander::pander(ResLMBootstrapTest$Pvalue)
```

# 6 ASCA/ASCA-E/APCA

These methods allow to represent the information from the effect matrices in a space of reduced dimensions. The function `PCALMEffects()` have a method argument to define which method to use.

## 6.1 ASCA

The ASCA method realizes PCAs on the effect matrices.

```{r ASCA PCA}
ResASCA = PCALMEffects(ResLMEffectMatrices = ResLMEffectMatrices,method="ASCA")
```

The contributions from each effect and their component are estimated and reported in tables with the function `PrintContributions()`. Moreover the function also output a barplot with the ordered contributions.

```{r ASCA Contrib}
ResPrintContributions = PrintContributions(ResASCA)

ResPrintContributions$Barplot

pander::pander(ResPrintContributions$EffectTable)
pander::pander(ResPrintContributions$ContribTable)
```

The score matrices are then represented on two components with the function `PlotScoresXY()`.

```{r ASCA ScoresXY}
PlotScoresXY(ResASCA,trout$design,EffectVector = "Day",varname.color = "Day",varname.pch = "Day")
PlotScoresXY(ResASCA,trout$design,EffectVector = "Treatment:Day",varname.color = "Treatment",varname.pch = "Day")
PlotScoresXY(ResASCA,trout$design,EffectVector = "Treatment",varname.color = "Treatment",varname.pch = "Treatment")
```

Finally we can represent the scores with a matrix of plots. This graph allows to observe multiple variables simultaneously.

```{r ASCA ScoresMatrix}
PlotScoresMatrix(ResASCA,
                 alleffect = FALSE,
                 EffectNames = c("Treatment","Exposure.Cd","Day","Treatment:Day","Exposure.Cd:Day","Treatment:Exposure.Cd","Treatment:Exposure.Cd:Day","Residuals"),
                 ModelAbbrev = TRUE,
                 PCdim=c(1,1,1,1,1,1,1,2),
                 design=trout$design,
                 varname.colorup = "Treatment",
                 vec.colorup = c("blue","forestgreen","red", "yellow"),
                 varname.colordown  = "Exposure.Cd",
                 vec.colordown = c("orange","black"),
                 varname.pchup="Day",
                 vec.pchup = c(4,16,2),
                 varname.pchdown="Day",
                 vec.pchdown = c(1,3,5))
```

```{r ASCA loadings}
PlotLoadings(ResASCA,
             EffectNames = c("Day","Treatment:Day"),
             PCdim = c(1,1),
             xaxis_type ="character",
             loadingstype = "s")
```


## 6.2 ASCA-E

The ASCA-E method realises PCAs on the effect matrices then adds the residuals. The same functions are used.

```{r ASCAE PCA}
ResASCAE = PCALMEffects(ResLMEffectMatrices = ResLMEffectMatrices,method="ASCA-E")
```

```{r ASCAE Contrib}
ResPrintContributions = PrintContributions(ResASCAE)

ResPrintContributions$Barplot

pander::pander(ResPrintContributions$EffectTable)
pander::pander(ResPrintContributions$ContribTable)
```

```{r ASCAE ScoresXY}
PlotScoresXY(ResASCAE,trout$design,EffectVector = "Day",varname.color = "Day",varname.pch = "Day")
PlotScoresXY(ResASCAE,trout$design,EffectVector = "Treatment:Day",varname.color = "Treatment",varname.pch = "Day")
```

```{r ASCAE ScoresMatrix}
PlotScoresMatrix(ResASCAE,
                 alleffect = FALSE,
                 EffectNames = c("Treatment","Exposure.Cd","Day","Treatment:Day","Exposure.Cd:Day","Treatment:Exposure.Cd","Treatment:Exposure.Cd:Day","Residuals"),
                 ModelAbbrev = TRUE,
                 PCdim=c(1,1,1,1,1,1,1,2),
                 design=trout$design,
                 varname.colorup = "Treatment",
                 vec.colorup = c("blue","forestgreen","red", "yellow"),
                 varname.colordown  = "Exposure.Cd",
                 vec.colordown = c("orange","black"),
                 varname.pchup="Day",
                 vec.pchup = c(4,16,2),
                 varname.pchdown="Day",
                 vec.pchdown = c(1,3,5))
```

``` {r ASCAE loadings}
PlotLoadings(ResASCAE,
             EffectNames = c("Day","Treatment:Day"),
             PCdim = c(1,1),
             xaxis_type ="character",
             loadingstype = "s")
```


## 6.3 APCA

The APCA method realises PCAs on the effect matrices augmented by the residuals. The same functions are used.

```{r APCA PCA}
ResAPCA = PCALMEffects(ResLMEffectMatrices = ResLMEffectMatrices,method="APCA")
```

```{r APCA Contrib}
ResPrintContributions = PrintContributions(ResAPCA)

ResPrintContributions$Barplot

pander::pander(ResPrintContributions$EffectTable)
pander::pander(ResPrintContributions$ContribTable)
```

```{r APCA ScoresXY}
PlotScoresXY(ResAPCA,trout$design,EffectVector = "Day",varname.color = "Day",varname.pch = "Day")
PlotScoresXY(ResAPCA,trout$design,EffectVector = "Treatment:Day",varname.color = "Treatment",varname.pch = "Day")
```

```{r APCA ScoresMatrix}
PlotScoresMatrix(ResAPCA,
                 alleffect = FALSE,
                 EffectNames = c("Treatment","Exposure.Cd","Day","Treatment:Day","Exposure.Cd:Day","Treatment:Exposure.Cd","Treatment:Exposure.Cd:Day","Residuals"),
                 ModelAbbrev = TRUE,
                 PCdim=c(1,1,1,1,1,1,1,2),
                 design=trout$design,
                 varname.colorup = "Treatment",
                 vec.colorup = c("blue","forestgreen","red", "yellow"),
                 varname.colordown  = "Exposure.Cd",
                 vec.colordown = c("orange","black"),
                 varname.pchup="Day",
                 vec.pchup = c(4,16,2),
                 varname.pchdown="Day",
                 vec.pchdown = c(1,3,5))
```

```{r APCA plot residuals}

PlotScoresMatrix(ResAPCA,
                 alleffect = FALSE,
                 EffectNames = "Residuals",
                 ModelAbbrev = TRUE,
                 PCdim=2,
                 design=trout$design,
                 varname.colorup = "Treatment",
                 vec.colorup = c("blue","forestgreen","red", "yellow"),
                 varname.colordown  = "Exposure.Cd",
                 vec.colordown = c("orange","black"),
                 varname.pchup="Day",
                 vec.pchup = c(4,16,2))

plot(ResAPCA$Residuals$scores)
```

``` {r APCA loadings}
PlotLoadings(ResAPCA,
             EffectNames = c("Day","Treatment:Day"),
             PCdim = c(1,1),
             xaxis_type ="character",
             loadingstype = "s")
```


# 7 Session info
```{r}
sessionInfo()
```

# References
